# å•ä½“æ¶æ„

**å•ä½“æ¶æ„**ï¼š å°†æ‰€æœ‰ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²

ä¼˜ç‚¹ï¼š

- æ¶æ„ç®€å•
- éƒ¨ç½²æˆæœ¬ä½

ç¼ºç‚¹ï¼š

- å›¢é˜Ÿåä½œæˆæœ¬é«˜
- ç³»ç»Ÿå‘å¸ƒæ•ˆç‡ä½
- ç³»ç»Ÿå¯ç”¨æ€§å·®

# å¾®æœåŠ¡

å¾®æœåŠ¡æ¶æ„ï¼Œæ˜¯æœåŠ¡åŒ–æ€æƒ³æŒ‡å¯¼ä¸‹çš„ä¸€å¥—æœ€ä½³å®è·µæ¶æ„æ–¹æ¡ˆã€‚å°±æ˜¯æŠŠå•ä½“æ¶æ„ä¸­çš„åŠŸèƒ½æ¨¡å—æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„é¡¹ç›®ã€‚

- ç²’åº¦å°
- å›¢é˜Ÿè‡ªæ²»
- æœåŠ¡è‡ªæ²»

> å°è®°ï¼š
>
> ä»Šå¤©åœ¨å¯¼å…¥é»‘é©¬å•†åŸé¡¹ç›®çš„æ—¶å€™ï¼Œå› ä¸ºæˆ‘æ˜¯linuxç¯å¢ƒï¼Œè€Œæ•™ç¨‹ä¸­æ˜¯windowsç¯å¢ƒï¼Œæ‰€ä»¥å…³äºhm-nginxè¿™ä¸ªå‰ç«¯é¡¹ç›®çš„å¯¼å…¥æœ‰ç‚¹ä¸ä¸€æ ·ã€‚æˆ‘æ˜¯ä½¿ç”¨çš„dockerè¿›è¡Œnginxå®¹å™¨çš„åˆ›å»ºï¼Œç„¶åæŠŠé¡¹ç›®çš„é…ç½®æ–‡ä»¶nginx.confï¼Œç½‘é¡µç›®å½•htmlï¼Œæ—¥å¿—ç›®å½•logsæŒ‚è½½åˆ°å®¹å™¨ä¸­å»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æŒ‚è½½çš„æ—¶å€™å¯ä»¥ä¸€æ¬¡æ€§æ˜ å°„å¤šä¸ªç«¯å£ï¼Œè¿™å–å†³äºé…ç½®æ–‡ä»¶ä¸­çš„serveræ•°é‡ã€‚å¹¶ä¸”æ˜ å°„è¿‡å»çš„é…ç½®æ–‡ä»¶ä¸­çš„rootè·¯å¾„ï¼Œå¿…é¡»æ˜¯dockerå®¹å™¨ä¸­çš„è·¯å¾„ã€‚é¡¹ç›®è·‘èµ·æ¥æ­£å¸¸ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯è®¿é—®å®¿ä¸»æœºåç«¯æœåŠ¡ç«¯å£æ—¶æŠ¥é”™ï¼š502 bad gatewayã€‚ å…ˆå»æŸ¥çœ‹å®¿ä¸»æœºä¸Šçš„logsæ—¥å¿—ï¼Œ è¿™æ ·æ˜¾ç¤º`2023/12/08 09:34:52 [error] 29#29: *2 connect() failed (111: Connection refused) while connecting to upstream, client: 172.17.0.1, server: localhost, request: "POST /api/users/login HTTP/1.1", upstream: "http://127.0.0.1:8080/users/login", host: "localhost:18080", referrer: "http://localhost:18080/login.html"` è¿™ä¸ªå…¶å®å°±æ˜¯é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„ä»£ç†ipæ˜¯localhostï¼Œlocalhoståœ¨dockerå®¹å™¨ä¸­æŒ‡çš„æ˜¯dockerè‡ªèº«çš„ip, è€Œä¸æ˜¯æˆ‘å®¿ä¸»æœºçš„ipï¼Œå› æ­¤å®¹å™¨å°è¯•è®¿é—®8080ç«¯å£æ—¶ï¼Œç”±äºæ²¡æœ‰å¯¹åº”çš„åç«¯æœåŠ¡ï¼Œæ‰€ä»¥å‡ºç°æ‹’ç»è¿æ¥çš„æŠ¥é”™ã€‚æ‰€ä»¥åªéœ€è¦æŠŠä»£ç†ipæ”¹æˆå®¿ä¸»æœºçš„çœŸå®ipåœ°å€å°±å¥½( ä½¿ç”¨`hostname -I `å‘½ä»¤å¿«é€ŸæŸ¥çœ‹æœ¬æœºæ‰€æœ‰ip ) ä¹Ÿå°±æ˜¯ `proxy_pass http://192.168.1.115:8080;`è¿™ç§å½¢å¼ï¼Œè€Œé `proxy_pass http://localhost:8080;`ã€‚

> ä»¥å‰æˆ‘æ€»å–œæ¬¢ç”¨localhostæ¥ä»£æ›¿127.0.0.1è¿™ç§ç±»ä¼¼çš„æ•°å­—ä¹¦å†™å½¢å¼ï¼Œå› ä¸ºæˆ‘è§‰å¾—localhostä¹¦å†™æ¯”è¾ƒç®€ä¾¿ã€‚ä½†æ˜¯ç°åœ¨çœ‹æ¥ï¼ŒæŸäº›åœºæ™¯ä¸‹localhostå¹¶ä¸é€šç”¨ã€‚çœ‹æ¥è¿˜æ˜¯æ•°å­—ä¹¦å†™å½¢å¼æ¯”è¾ƒå¥½ã€‚æˆ‘æ²¡æœ‰ç‰¹æ„çš„å»å­¦è¿‡dockerï¼Œ åªæ˜¯äº†è§£äº†ä¸€äº›æŒ‚è½½æ–‡ä»¶ä¹‹ç±»çš„æ–¹æ³•ã€‚ä¹‹å‰è¿˜æœ‰ç‚¹æ‡µæ‡‚çš„ï¼Œç»è¿‡nginxè¿™ä¸€æŠ˜è…¾ï¼Œæˆ‘ç°åœ¨å¯¹äºdockerçš„ç†è§£å’Œä½¿ç”¨å·²ç»å‡äº†ä¸€ä¸ªæ¡£æ¬¡äº†ï¼ŒåŒæ—¶å¯¹nginxä¹Ÿæœ‰æ‰€äº†è§£ã€‚éå¸¸é«˜å…´ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªè¿‡ç¨‹å€¼å¾—è®°å½•ï¼Œå› æ­¤å†™ä¸‹è¿™ç¯‡å°è®°ã€‚

# SpringCloud

å®˜ç½‘ï¼šhttps://spring.io/projects/spring-cloud/

é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„å»ºï¼ŒåŸºäºspringbootå®ç°è¿™äº›ç»„å»ºçš„è‡ªåŠ¨è£…å¤‡ï¼Œæä¾›è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒï¼š

- æœåŠ¡æ³¨å†Œå‘ç° `Eureka` `Nacos` `Consul`
- æœåŠ¡è¿œç¨‹è°ƒç”¨ `OpenFeign` `Dubbo`
- æœåŠ¡é“¾è·¯ç›‘æ§ `Zipkin` `Sleuth`
- ç»Ÿä¸€é…ç½®ç®¡ç† `SpringCloudConfig` `Nacos`
- ç»Ÿä¸€ç½‘å…³è·¯ç”± `SpringCloudGateway` `Zuul`
- æµæ§ã€é™çº§ã€ä¿æŠ¤ `Hystix` `Sentinel`

![](img/2023-12-08_17-57.png)

# å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™

## ä»€ä¹ˆæ—¶å€™æ‹†åˆ†ï¼Ÿ

- åˆ›ä¸šå‹é¡¹ç›®

å…ˆé‡‡ç”¨å•ä½“æ¶æ„ï¼Œå¿«é€Ÿå¼€å‘ï¼Œå¿«é€Ÿè¯•é”™ã€‚éšç€è§„æ¨¡æ‰©å¤§ï¼Œé€æ¸æ‹†åˆ†

- ç¡®å®šçš„å¤§å‹é¡¹ç›®

èµ„é‡‘å……è¶³ï¼Œç›®æ ‡æ˜ç¡®ï¼Œç›´æ¥é€‰æ‹©å¾®æœåŠ¡æ¶æ„ï¼Œé¿å…åç»­æ‹†åˆ†çš„éº»çƒ¦

## ç›®æ ‡

- é«˜å†…èš
- ä½è€¦åˆ

## æ–¹å¼

- çºµå‘æ‹†åˆ†ï¼šæŒ‰ç…§ä¸šåŠ¡æ¨¡å—æ¥æ‹†åˆ†

- æ¨ªå‘æ‹†åˆ†ï¼šæŠ½å–å…¬å…±æœåŠ¡ï¼Œæé«˜å¤ç”¨æ€§

## æ‹†åˆ†

å¾®æœåŠ¡åœ¨ä¼ä¸šä¸­æœ‰ä¸¤ç§å·¥ç¨‹ç»“æ„ï¼š

- ç‹¬ç«‹project

- Mavenèšåˆ

[æŸ¥çœ‹ä»£ç ](hmall/)  

# è¿œç¨‹è°ƒç”¨ğŸŒŸ

Springæä¾›ä¸€ä¸ª`RestTemplate`å·¥å…·ï¼Œå¯ä»¥å®ç°Httpè¯·æ±‚çš„å‘é€ã€‚

1. æ³¨å…¥`RestTemplate`åˆ°springå®¹å™¨

   ```java
   @Bean
   public RestTemplate restTemplate(){
       return new RestTemplate();
   }
   ```

2. å‘èµ·è¿œç¨‹è°ƒç”¨

   ```java
   //2.1åˆ©ç”¨restTemplateå‘èµ·httpè¯·æ±‚ï¼Œå¾—åˆ°httpå“åº”
   ResponseEntity<List<ItemDTO>> response = restTemplate.exchange(
           "http://localhost:8081/items?ids={ids}",  //è¯·æ±‚è·¯å¾„
           HttpMethod.GET,   //è¯·æ±‚æ–¹å¼ 
       	null,  //è¯·æ±‚å®ä½“
           new ParameterizedTypeReference<List<ItemDTO>>() {
           },  //è¿”å›å€¼ç±»å‹ï¼Œç”±äºè¿™é‡Œè¿”å›å€¼æ˜¯ä¸€ä¸ªList,æ‰€ä»¥æ˜¯è¿™ç§å†™æ³•
       	Map.of("ids", CollUtil.join(itemIds, ","))  //è¯·æ±‚å‚æ•°
   );
   ```

# æœåŠ¡æ²»ç†ğŸŒŸ

## æ³¨å†Œä¸­å¿ƒ

![](img/2023-12-12_15-52.png)

ä¸‰ä¸ªè§’è‰²ï¼š 

- æœåŠ¡æä¾›è€… ï¼š æš´éœ²æœåŠ¡æ¥å£ï¼Œä¾›å…¶ä»–æœåŠ¡è°ƒç”¨
- æœåŠ¡è°ƒç”¨è€… ï¼š è°ƒç”¨å…¶ä»–æœåŠ¡æä¾›çš„æ¥å£
- æ³¨å†Œä¸­å¿ƒ ï¼š è®°å½•å¹¶ç›‘æ§å¾®æœåŠ¡å„å®ä¾‹çŠ¶æ€ï¼Œæ¨é€æœåŠ¡å˜æ›´ä¿¡æ¯

## Nacos

Nacosæ˜¯alibabaçš„äº§å“ï¼Œç›®å‰å·²åŠ å…¥åˆ°SpringCloudAlibabaä¸­ã€‚

å®˜æ–¹æ–‡æ¡£ï¼šhttps://nacos.io/zh-cn/docs/quick-start.html

### éƒ¨ç½²

<details>
    <summary>éƒ¨ç½²è¿‡ç¨‹å‚è€ƒ</summary>
ä½¿ç”¨dockeræ–¹å¼éƒ¨ç½²nacosï¼šhttps://cloud.tencent.com/developer/article/2294185
</details>

---

1. åˆ›å»º[nacosæ•°æ®åº“](resources/nacos.sql)ç”¨äºå­˜å‚¨å…ƒæ•°æ®

2. é…ç½®[ç¯å¢ƒé…ç½®æ–‡ä»¶](resources/custom.env)

   ```.env
   PREFER_HOST_MODE=hostname
   MODE=standalone  # è¿è¡Œæ¨¡å¼
   SPRING_DATASOURCE_PLATFORM=mysql  # æ•°æ®åº“
   MYSQL_SERVICE_HOST=192.168.1.115  # å®¿ä¸»æœºipåœ°å€
   MYSQL_SERVICE_DB_NAME=nacos  # æ•°æ®åº“å
   MYSQL_SERVICE_PORT=3307  # æ•°æ®åº“ç«¯å£
   MYSQL_SERVICE_USER=root  # æ•°æ®åº“ç”¨æˆ·å
   MYSQL_SERVICE_PASSWORD=123  # æ•°æ®åº“å¯†ç 
   MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai  # æ•°æ®åº“è¿æ¥å‚æ•°
   ```

3. åˆ›å»ºå®¹å™¨

   ```bash
   docker run -d \
   --name nacos \
   --env-file ./nacos/custom.env \
   -p 8848:8848 \
   -p 9848:9848 \
   -p 9849:9849 \
   --restart=always \
   nacos/nacos-server:latest
   ```

4. è®¿é—®nacos http://localhost:8848/nacos/

è´¦å·å¯†ç éƒ½æ˜¯`nacos`

## æœåŠ¡æ³¨å†Œ

1. å¼•å…¥nacos discoveryä¾èµ–

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
       <version>2022.0.0.0</version>
   </dependency>
   ```

2. é…ç½®nacosåœ°å€

   ```yaml
   spring:
   	application:
   		name: item-service # æœåŠ¡åç§°
       cloud:
       	nacos:
       		server-addr: 192.168.1.115:8848 #nacosåœ°å€
   ```

3. å¯åŠ¨æœåŠ¡ï¼Œè®¿é—®nacosæ³¨å†Œä¸­å¿ƒ

![](img/2023-12-12_17-27.png)

## æœåŠ¡å‘ç°

1. å¼•å…¥nacos discoveryä¾èµ–
2. é…ç½®nacosåœ°å€

3. æœåŠ¡å‘ç°

   - springcloudæä¾›çš„é¡¶çº§æ¥å£`DiscoveryClient`ç”¨äºå®ç°æœåŠ¡å‘ç°åŠŸèƒ½

   ```java
   //1.ä¾èµ–æ³¨å…¥
   private final DiscoveryClient discoveryClient;
   //2.æ ¹æ®æœåŠ¡åç§°è·å–å®ä¾‹åˆ—è¡¨
   List<ServiceInstance> instances = discoveryClient.getInstances("item-service");
   //3.é€šè¿‡è´Ÿè½½å‡è¡¡è·å–å…·ä½“å®ä¾‹
   ServiceInstance instance = instances.get(RandomUtil.randomInt(instances.size()));
   //è·å–åˆ°å®ä¾‹åï¼Œå°±å¯ä»¥æ‹¿åˆ°è¯¥å®ä¾‹çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ip,ç«¯å£ç­‰
   //4.é€šè¿‡å…·ä½“å®ä¾‹çš„ä¿¡æ¯ï¼Œè¿›è¡Œè¿œç¨‹è°ƒç”¨...
   ResponseEntity<List<ItemDTO>> response = restTemplate.exchange(
           "http://"+instance.getUri()+"/items?ids={ids}",
           HttpMethod.GET, null,
           new ParameterizedTypeReference<List<ItemDTO>>() {
           }, Map.of("ids", CollUtil.join(itemIds, ","))
   );
   ```

# OpenFeignğŸŒŸ

OpenFeignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„httpå®¢æˆ·ç«¯ï¼Œå¯ä»¥è®©æˆ‘ä»¬è¿œç¨‹è°ƒç”¨çš„æ­¥éª¤å˜å¾—ç®€å•ã€‚

å®˜æ–¹åœ°å€ï¼šhttps://github.com/OpenFeign/feign

## ä½¿ç”¨

1. å¼•å…¥ä¾èµ–ï¼ŒåŒ…æ‹¬ OpenFeignå’Œè´Ÿè½½å‡è¡¡çš„ç»„ä»¶SpringCloudLoadBalancer ï¼ˆä»¥å‰æ˜¯Ribbonï¼‰

   ```xml
   <!--openFeign-->
   <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-openfeign</artifactId>
   </dependency>
   <!--è´Ÿè½½å‡è¡¡å™¨-->
   <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-loadbalancer</artifactId>
   </dependency>
   ```

2. é€šè¿‡åœ¨å¯åŠ¨ç±»å‰åŠ ä¸Š `@EnableFeignClients`æ³¨è§£ï¼Œå¯ç”¨OpenFeign

   ```java
   @EnableFeignClients
   @MapperScan("com.hmall.cart.mapper")
   @SpringBootApplication
   public class CartApplication {  ...
   ```

3. ç¼–å†™FeignClient

   ```java
   @FeignClient(value = "item-service")
   public interface ItemClient {
       @GetMapping("/items")
       List<ItemDTO> queryItemByIds(@RequestParam("ids") Collection<Long> ids);
   }
   ```

4. ä½¿ç”¨FeignClient, å®ç°è¿œç¨‹è°ƒç”¨

   ```java
   List<ItemDTO> items = itemClient.queryItemByIds(itemIds);
   ```

## è¿æ¥æ± 

å…¶è‡ªå¸¦çš„httpè¯·æ±‚çš„å®ç°æ–¹å¼æ˜¯`HttpURLConnection`, è¯¥å®ç°ä¸æ”¯æŒè¿æ¥æ± ã€‚æˆ‘ä»¬å¯ä»¥æ›¿æ¢ä¸º`Apache HttpClient`æˆ–è€…`OKHttp`è¿™ç§æ”¯æŒè¿æ¥æ± çš„å®ç°æ–¹å¼ï¼Œæ¥å¢å¼ºè¿œç¨‹è°ƒç”¨çš„æ€§èƒ½ã€‚

### æ­¥éª¤

1. å¼•å…¥ä¾èµ–

   ```xml
   <!--OK http çš„ä¾èµ– -->
   <dependency>
     <groupId>io.github.openfeign</groupId>
     <artifactId>feign-okhttp</artifactId>
   </dependency>
   ```

2. å¼€å¯è¿æ¥æ± åŠŸèƒ½

   ```yml
   feign:
     okhttp:
       enabled: true
   ```

## æœ€ä½³å®è·µ

- é¡¹ç›®æ˜¯mavenèšåˆç»“æ„ï¼Œå¯ä»¥é€‰æ‹©æ–°å¢ä¸€ä¸ªé€šç”¨çš„æ¨¡å—ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰æ¨¡å—å¯¹å¤–æš´éœ²çš„å®¢æˆ·ç«¯ç­‰ï¼Œè¿™ç§æ–¹å¼é¡¹ç›®çš„è€¦åˆåº¦ä¼šæ›´é«˜

  ![](img/2023-12-12_19-18_1.png)

- é¡¹ç›®æ˜¯ç‹¬ç«‹projectç»“æ„ï¼Œå¯ä»¥é€‰æ‹©æ¯ä¸ªæ¨¡å—è´Ÿè´£å„è‡ªå¯¹å¤–æš´éœ²çš„æ¥å£ï¼Œä»¥åŠæ•°æ®ä¼ è¾“å¯¹è±¡ç­‰

  ![](img/2023-12-12_19-18.png)

æœ¬æ•™å­¦å®ä¾‹é‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ã€‚

é¦–å…ˆéœ€è¦æŠ½å–Feignå®¢æˆ·ç«¯ï¼Œæ–°å»ºä¸€ä¸ªhm-apiæ¨¡å—ï¼Œå°†openfeignä¾èµ–å’Œloadbalancerä¾èµ–è½¬ç§»è¿‡å»ï¼Œç„¶åå°†feignå®¢æˆ·ç«¯å’Œdtoå¯¹è±¡ä»£ç è½¬ç§»å³å¯ã€‚

![](img/2023-12-13_15-30.png)

ç„¶ååœ¨éœ€è¦ä½¿ç”¨å®¢æˆ·ç«¯çš„å¾®æœåŠ¡ä¸­å¼•å…¥è¯¥hm-apiæ¨¡å—ã€‚ç”±äºhm-apiæ¨¡å—ä¸­çš„å®¢æˆ·ç«¯æ‰€åœ¨åŒ…ä¸cart-serviceå¯åŠ¨ç±»æ‰€åœ¨åŒ…ä¸åŒï¼Œå› æ­¤ç›´æ¥å¯åŠ¨ä¼šæ— æ³•æ‰¾åˆ°feignclientè¿™ä¸ªbeanã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ‰«æè¿™ä¸ªåŒ…ã€‚åœ¨å¯åŠ¨ç±»çš„`@EnableFeignClients`æ³¨è§£ä¸Šæ·»åŠ æ‰«åŒ…å‚æ•°ï¼Œå³å¯æ­£å¸¸ä½¿ç”¨openfeignå®¢æˆ·ç«¯ã€‚

![](img/2023-12-13_15-33.png)

## æ—¥å¿—

OpenFeignçš„æ—¥å¿—åªæœ‰åœ¨é¡¹ç›®çš„æ—¥å¿—çº§åˆ«ä¸ºdebugçº§åˆ«æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚å…¶è‡ªèº«æ—¥å¿—ä¹Ÿåˆ†ä¸ºå‡ ä¸ªçº§åˆ«ã€‚é»˜è®¤æ˜¯noneä¸ç”Ÿäº§ä»»ä½•æ—¥å¿—ã€‚æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¿®æ”¹æ—¥å¿—ç­‰çº§ã€‚

1. ç”Ÿå‘½ä¸€ä¸ªç±»å‹ä¸ºLogger.Levelçš„Beanï¼Œåœ¨å…¶ä¸­å®šä¹‰æ—¥å¿—çº§åˆ«

   ```java
   public class DefaultFeignConfig {
       @Bean
       public Logger.Level feignLoggerLevel(){
           return Logger.Level.FULL;
       }
   }
   ```

2. æ­¤æ—¶beanè¿˜æ²¡æœ‰ç”Ÿæ•ˆï¼Œæƒ³è¦é…ç½®å•ç‹¬çš„æŸä¸ªFeignClientçš„æ—¥å¿—ï¼Œå¯ä»¥åœ¨`@FeignClient`æ³¨è§£ä¸­åŠ ä¸Šè¯¥é…ç½®ç±»å±æ€§

   ```java
   @FeignClient(value="item-service",configuration = DefaultFeignConfig.class)
   ```

3. æƒ³è¦å…¨å±€é…ç½®ï¼Œè®©æ‰€æœ‰çš„FeignClientéƒ½æŒ‰ç…§è¿™ä¸ªæ—¥å¿—ç­‰çº§è¾“å‡ºæ—¥å¿—ï¼Œéœ€è¦åœ¨å¯åŠ¨ç±»çš„`@EnableFeignClient`æ³¨è§£ä¸­åŠ ä¸Šé…ç½®ç±»å±æ€§

   ```java
   @EnableFeignClients(basePackages = "com.hmall.api.client",defaultConfiguration = DefaultFeignConfig.class)
   ```


# ç½‘å…³

ç½‘å…³è´Ÿè´£è¯·æ±‚çš„è·¯ç”±ï¼Œè½¬å‘å’Œèº«ä»½æ ¡éªŒç­‰

![gateway](img/2023-12-15_17-02.png)

SpringCloudæä¾›ä¸¤ä¸ªç½‘å…³ç»„ä»¶ï¼š

- SpringCloud Gateway  - åŸºäºWebFluxå“åº”å¼ç¼–ç¨‹âœ…
- Netfilx Zuul - åŸºäºServletçš„é˜»å¡å¼ç¼–ç¨‹â

## ç½‘å…³è·¯ç”±

å¼€å‘è€…éœ€è¦é…ç½®ä¸€äº›**è·¯ç”±è§„åˆ™**ï¼Œå‘Šè¯‰ç½‘å…³å¦‚ä½•è·¯ç”±è¯·æ±‚ã€‚

ç½‘å…³æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œéœ€è¦æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸­å»ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ç½‘å…³ç¬¬ä¸€æ­¥å°±æ˜¯åˆ›å»ºä¸€ä¸ªç½‘å…³æœåŠ¡

### å®æ–½æ­¥éª¤

1. åˆ›å»ºç½‘å…³å¾®æœåŠ¡æ¨¡å—

2. å¼•å…¥ç›¸å…³ä¾èµ–

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <project xmlns="http://maven.apache.org/POM/4.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
       <parent>
           <artifactId>hmall</artifactId>
           <groupId>com.heima</groupId>
           <version>1.0.0</version>
       </parent>
       <modelVersion>4.0.0</modelVersion>
   
       <artifactId>hm-gateway</artifactId>
   
       <properties>
           <maven.compiler.source>11</maven.compiler.source>
           <maven.compiler.target>11</maven.compiler.target>
       </properties>
       <dependencies>
           <!--common  é¡¹ç›®çš„é€šç”¨å·¥å…·æ¨¡å—-->
           <dependency>
               <groupId>com.heima</groupId>
               <artifactId>hm-common</artifactId>
               <version>1.0.0</version>
           </dependency>
           <!--ç½‘å…³-->
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-gateway</artifactId>
           </dependency>
           <!--nacos discovery  æ³¨å†Œä¸­å¿ƒ-->
           <dependency>
               <groupId>com.alibaba.cloud</groupId>
               <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
           </dependency>
           <!--è´Ÿè½½å‡è¡¡-->
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-loadbalancer</artifactId>
           </dependency>
       </dependencies>
       <!-- springbootæ‰“åŒ…ç¼–è¯‘æ’ä»¶ -->
       <build>
           <finalName>${project.artifactId}</finalName>
           <plugins>
               <plugin>
                   <groupId>org.springframework.boot</groupId>
                   <artifactId>spring-boot-maven-plugin</artifactId>
               </plugin>
           </plugins>
       </build>
   </project>
   ```

3. å¯åŠ¨ç±»

   ```java
   package com.hmall.gateway;
   
   import org.springframework.boot.SpringApplication;
   import org.springframework.boot.autoconfigure.SpringBootApplication;
   
   @SpringBootApplication
   public class GatewayApplication {
       public static void main(String[] args) {
           SpringApplication.run(GatewayApplication.class, args);
       }
   }
   
   ```

4. é…ç½®è·¯ç”±

   ```yaml
   server:
     port: 8080
   spring:
     application:
       name: gateway
     cloud:
       nacos:
         server-addr: 192.168.1.121:8848  # nacos
       gateway:
         routes:
           - id: item # è·¯ç”±è§„åˆ™idï¼Œè‡ªå®šä¹‰ï¼Œå”¯ä¸€
             uri: lb://item-service # è·¯ç”±çš„ç›®æ ‡æœåŠ¡ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åˆ—è¡¨
             predicates: # è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è§„åˆ™ï¼Œç¬¦åˆåˆ™è·¯ç”±åˆ°ç›®æ ‡æœåŠ¡
               - Path=/items/**,/search/** # è¿™é‡Œæ˜¯ä»¥è¯·æ±‚è·¯å¾„ä½œä¸ºåˆ¤æ–­è§„åˆ™
           - id: cart
             uri: lb://cart-service
             predicates:
               - Path=/carts/**
           - id: user
             uri: lb://user-service
             predicates:
               - Path=/users/**,/addresses/**
           - id: trade
             uri: lb://trade-service
             predicates:
               - Path=/orders/**
           - id: pay
             uri: lb://pay-service
             predicates:
               - Path=/pay-orders/**
   
   ```

### å…¶ä»–çš„è·¯ç”±å±æ€§

ç½‘å…³è·¯ç”±å¯¹åº”çš„Javaç±»å‹æ˜¯`RouteDefinition`ï¼Œå…¶ä¸­å¸¸è§çš„å±æ€§æœ‰ï¼š

- `id` : è·¯ç”±å”¯ä¸€æ ‡è¯†
- `uri` ï¼šè·¯ç”±ç›®æ ‡åœ°å€
- `predicates` ï¼š è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è·¯ç”±
- `filters` ï¼šè·¯ç”±è¿‡æ»¤ï¼Œ å¯¹è¯·æ±‚æˆ–å“åº”åšç‰¹æ®Šå¤„ç† 

![](img/2023-12-15_17-55.png)

#### Predicatesè·¯ç”±æ–­è¨€

springæä¾›äº†12ä¸­åŸºæœ¬çš„`RoutePredicateFactory`å®ç°ï¼š

![](img/2023-12-15_18-00.png)

å…·ä½“ä»‹ç»æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/request-predicates-factories.html)

#### Filtersè·¯ç”±è¿‡æ»¤

springæä¾›33ç§è·¯ç”±è¿‡æ»¤å™¨

![](img/2023-12-15_18-05.png)

å…·ä½“ä»‹ç»æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/gatewayfilter-factories/addrequestheader-factory.html)

#### å…¨å±€è·¯ç”±è¿‡æ»¤å™¨ 

æƒ³è¦ä¸ºæ‰€æœ‰æ¥å£æ·»åŠ è·¯ç”±è¿‡æ»¤å™¨ï¼ŒæŒ‡å®š`default-filters`å±æ€§ï¼ˆä¸routesåŒçº§ï¼‰å³å¯ï¼š

```yaml
    spring:
        cloud:    
            gateway:
>     			routes: <5 items>
              	default-filters:
                	- AddRequestHeader=truth,bagayalu
```



> âš ï¸æ³¨æ„ï¼š
>
> åœ¨ä¹¦å†™predicateså’Œfilterså±æ€§æ—¶ï¼Œnameå’Œargsä¹‹é—´å¦‚æœé‡‡ç”¨ç®€å†™å½¢å¼ï¼Œå³`- Path=/addresses/**`  ä¹‹é—´ä¸è¦å­˜åœ¨ç©ºæ ¼ã€‚nameå’Œargséœ€è¦ç´§å¯†è¿åœ¨ä¸€èµ·ï¼Œå¦åˆ™å¯åŠ¨æœåŠ¡ä¼šæŠ¥é”™ï¼



## ç½‘å…³ç™»é™†æ ¡éªŒ

![](img/2023-12-15_18-49.png)

ç½‘å…³è¯·æ±‚å¤„ç†æµç¨‹ï¼š

![](img/2023-12-15_18-43.png)

æ ¹æ®æ‰§è¡Œæµç¨‹å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨ç½‘å…³è½¬å‘è¯·æ±‚ä¹‹å‰åšç™»é™†æ ¡éªŒï¼Œå°±éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå¹¶ä¸”åœ¨è¿‡æ»¤å™¨çš„preé˜¶æ®µè¿›è¡Œé€»è¾‘åˆ¤æ–­ã€‚

### è‡ªå®šä¹‰GlobalFilter

ç½‘å…³è¿‡æ»¤å™¨æœ‰ä¸¤ç§ï¼š 

- `GateWayFilter` : è·¯ç”±è¿‡æ»¤å™¨
- `GlobalFilter` : å…¨å±€è·¯ç”±è¿‡æ»¤å™¨

`GlobalFilter`ç±»çš„`filter`æ–¹æ³•æ¶‰åŠåˆ°çš„å‡ ä¸ªå‚æ•°ï¼š

- `ServerWebExchange`ï¼š è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…å«æ•´ä¸ªfilter-chainçš„å…±äº«æ•°æ®ï¼ŒåŒ…æ‹¬request,responseç­‰
- `GatewayFilterChain`ï¼šè¿‡æ»¤å™¨é“¾
- `Mono` ï¼šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œéé˜»å¡å¼çš„ã€‚è¯¥å›è°ƒå‡½æ•°å†…éƒ¨å…¶å®å°±æ˜¯è¿‡æ»¤çš„Postéƒ¨åˆ†éœ€è¦æ‰§è¡Œçš„å†…å®¹

1. åˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç°`GlobalFilter`æ¥å£ï¼Œé‡å†™å…¶ä¸­`filter`æ–¹æ³•ï¼Œæ·»åŠ è¿‡æ»¤é€»è¾‘

   ```java
   public class MyGlobalFilter implements GlobalFilter, Ordered {
       @Override
       public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
           // æ¨¡æ‹Ÿç™»é™†æ ¡éªŒé€»è¾‘
           ServerHttpRequest request = exchange.getRequest();
           HttpHeaders headers = request.getHeaders();
           System.out.println("header : "+headers);
           return chain.filter(exchange);
       }
   }
   ```

2. è¿˜è¦ä¿è¯æˆ‘ä»¬çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨æ¯”`NettyRoutingFilter`å…ˆæ‰§è¡Œï¼Œå°±è¦ä¿è¯æˆ‘ä»¬çš„ä¼˜å…ˆçº§æ¯”ä»–é«˜ã€‚è§‚å¯Ÿ`NettyRoutingFilter`æºç å‘ç°ï¼Œ`NettyRoutingFilter`é€šè¿‡å®ç°`Ordered`æ¥å£æ¥å®šä¹‰ä¼˜å…ˆçº§ã€‚`NettyRoutingFilter`çš„ä¼˜å…ˆçº§æ˜¯intçš„æœ€å¤§å€¼ï¼Œè¡¨ç¤ºå…¶ä¼˜å…ˆçº§åœ¨æ•´ä¸ªè¿‡æ»¤é“¾ä¸­æœ€ä½ã€‚æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ä¼˜å…ˆçº§çš„æ•°å­—åªè¦å°äºintçš„æœ€å¤§å€¼å°±å¥½äº†ã€‚è¿™æ ·æˆ‘ä»¬ä¼˜å…ˆçº§å°±é«˜äº`NettyRoutingFilter`äº†ã€‚

   ```java
   public class MyGlobalFilter implements GlobalFilter, Ordered {
       @Override
       public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
           // æ¨¡æ‹Ÿç™»é™†æ ¡éªŒé€»è¾‘
           ServerHttpRequest request = exchange.getRequest();
           HttpHeaders headers = request.getHeaders();
           System.out.println("header : "+headers);
           return chain.filter(exchange);
       }
   
       @Override
       public int getOrder() {
           return 0;  //ä¼˜å…ˆçº§é«˜äºNettyRoutingFilter
       }
   }
   ```

### è‡ªå®šä¹‰GatewayFilter

[æŸ¥çœ‹æ•™ç¨‹](https://www.bilibili.com/video/BV1kH4y1S7wz?p=29&spm_id_from=pageDriver&vd_source=4d79aa6bdc0ac3d438853bf8e2dd6928)

###  å®ç°ç™»é™†æ ¡éªŒ

#### å®ç°æ­¥éª¤

1. **ç”Ÿæˆjksæ ¼å¼ç§æœ‰å¯†é’¥**

   >ä½¿ç”¨keytool  - javaæä¾›çš„è¯ä¹¦ç®¡ç†å·¥å…·
   >
   >- alias å¯†é’¥åˆ«å
   >- keyalg ä½¿ç”¨çš„hashç®—æ³•
   >- keypass å¯†é’¥çš„è®¿é—®å¯†ç 
   >- keystore å¯†é’¥åº“çš„æ–‡ä»¶å  - è¯ä¹¦çš„æ–‡ä»¶å
   >- storepass å¯†é’¥åº“çš„è®¿é—®å¯†ç   - è®¿é—®è¯ä¹¦çš„å¯†ç 

   ```bash
   keytool -genkeypair -alias small-tools -keyalg RSA -keypass 123456 -keystore jwt.jks -storepass 123456
   ```

   æŸ¥è¯¢è¯ä¹¦

   ```bash
   keytool -list -keystore jwt.jks
   ```

2. **ç”Ÿäº§å…¬æœ‰å¯†é’¥**

   ```bash
   keytool -list -rfc --keystore jwt.jks | openssl x509 -inform pem -pubkey
   ```

3. **åœ¨yamlé…ç½®æ–‡ä»¶ä¸­é…ç½®Jwtä»¤ç‰Œ**

   ```yaml
   hm:
     jwt:
       location: classpath:hmall.jks    # å¯†é’¥ä½ç½®resourcesä¸‹
       alias: hmall  # å¯†é’¥åˆ«å
       password: hmall123  # è®¿é—®å¯†é’¥çš„å¯†ç 
       tokenTTL: 30m   
     auth:
       excludePaths: # ä¸éœ€è¦ç™»é™†æ ¡éªŒçš„è·¯å¾„
         - /search/**
         - /users/login
         - /items/**
         - /hi
   ```

   è¿™äº›é…ç½®ä¿¡æ¯éœ€è¦è¢«è·å–ï¼Œå› æ­¤éœ€è¦å®šä¹‰ä¸€äº›beanæ¥æ˜ å°„è¿™äº›ä¿¡æ¯ã€‚

4. **å®šä¹‰bean**

   - `AuthProperties è·å–authé…ç½®ä¿¡æ¯ï¼ˆæ”¾è¡Œè·¯å¾„ï¼‰[click](hmall/hm-gateway/src/main/java/com/hmall/gateway/config/AuthProperties.java)
   - `JwtProperties` è·å–jwté…ç½®ä¿¡æ¯ [click](hmall/hm-gateway/src/main/java/com/hmall/gateway/config/JwtProperties.java)
   - `SecurityConfig` è‡ªåŠ¨è£…é…å·¥å…· [click](hmall/hm-gateway/src/main/java/com/hmall/gateway/config/SecurityConfig.java)
   - `JwtTool` JWTå·¥å…·ï¼ŒåŒ…å«ç”Ÿæˆå’Œè§£æ`token`çš„åŠŸèƒ½ [click](hmall/hm-gateway/src/main/java/com/hmall/gateway/util/JwtTool.java) 
   - `**.jks`  å¯†é’¥æ–‡ä»¶ (æ”¾åœ¨resourcesä¸‹)

5. **è‡ªå®šä¹‰è¿‡æ»¤å™¨**

   ```java
   @Component
   @RequiredArgsConstructor
   public class AuthGlobalFilter implements GlobalFilter, Ordered {
   	
       private final AuthProperties authProperties;
       
       private final JwtTool jwtTool;
       //springæä¾›çš„è·¯å¾„åŒ¹é…å·¥å…·
       private final AntPathMatcher antPathMatcher = new AntPathMatcher();
   
       @Override
       public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
           //1.å–requestå¯¹è±¡
           ServerHttpRequest request = exchange.getRequest();
           //2.åˆ¤æ–­æ˜¯å¦éœ€è¦ç™»é™†æ‹¦æˆªï¼Œå¦‚æœä¸éœ€è¦ç›´æ¥æ”¾è¡Œ
           //2.1æ‹¿åˆ°éœ€è¦æ”¾è¡Œçš„è·¯å¾„,å¦‚æœåœ¨é…ç½®ä¸­ï¼Œå°±æ”¾è¡Œ
           if (isExclude(request.getPath().toString())) {
               //æ”¾è¡Œ
               return chain.filter(exchange);
           }
           //3. è·å– token
           String token = null;
           List<String> headers = request.getHeaders().get("authorization");
           if (headers != null && !headers.isEmpty()) {
               token = headers.get(0);
           }
           //4. è§£ætoken
           Long userId = null;
           try {
               userId = jwtTool.parseToken(token);
           } catch (UnauthorizedException e) {
               //æ‹¦æˆª è®¾ç½®å“åº”çŠ¶æ€ç ä¸º401
               ServerHttpResponse response = exchange.getResponse();
               response.setStatusCode(HttpStatus.UNAUTHORIZED);
               return response.setComplete();
           }
           //5. todo ä¼ é€’ç”¨æˆ·ä¿¡æ¯
           System.out.println("userID = " + userId);
           //6. æ”¾è¡Œ
           return chain.filter(exchange);
       }
   
       private boolean isExclude(String path) {
           //AntPathMatcherè¿›è¡Œè·¯å¾„åŒ¹é…
           for (String pathPattern : authProperties.getExcludePaths()) {
               if (antPathMatcher.match(pathPattern,path)) {
                   return true;
               }
           }
           return false;
       }
   
       @Override
       public int getOrder() {
           return 0;
       }
   }
   ```

   > ä½¿ç”¨äº†AntPathMatcherï¼Œè¿™æ˜¯ springæä¾›çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºå¤„ç†è·¯å¾„åŒ¹é…ã€‚æ”¯æŒä¸€äº›anté£æ ¼çš„è·¯å¾„åŒ¹é…è§„åˆ™ï¼Œæ¯”å¦‚`/**` è¡¨ç¤ºåŒ¹é…ä»»æ„è·¯å¾„ï¼Œ`*`è¡¨ç¤ºåŒ¹é…è·¯å¾„ä¸­çš„ä»»æ„å­—ç¬¦ï¼Œ`ï¼Ÿ`è¡¨ç¤ºåŒ¹é…è·¯å¾„ä¸­çš„ä¸€ä¸ªå­—ç¬¦ç­‰ã€‚

## ç½‘å…³ä¼ é€’ç”¨æˆ·

![](img/2023-12-16_15-32.png)

### å®ç°æ­¥éª¤

1. åœ¨ç½‘å…³ç™»é™†æ ¡éªŒè¿‡æ»¤å™¨ä¸­ï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ”¾åˆ°è¯·æ±‚å¤´ä¸­å»

   ä¸Šè¿°`//5. todo ä¼ é€’ç”¨æˆ·ä¿¡æ¯` bu zh o

   ```java
   //å°†ç”¨æˆ·ä¿¡æ¯å­˜åˆ°è¯·æ±‚å¤´ä¸­
   ServerWebExchange swe = exchange.mutate() //å¯¹ä¸‹æ¸¸è¯·æ±‚åšæ›´æ”¹
           .request(builder -> builder.header("user-info", userInfo))
           .build();
   //æ”¾è¡Œ
   return chain.filter(swe)
   ```

   > ä¸Šè¿°æ­¥éª¤æ˜¯åœ¨å»ºé€ ä¸€ä¸ªåŒ…å«"user-info"è¯·æ±‚å¤´çš„ä¸€ä¸ªæ–°çš„exchangeå¯¹è±¡ã€‚

2. åœ¨é€šç”¨æ¨¡å—ä¸­ç¼–å†™springmvcæ‹¦æˆªå™¨ï¼Œè·å–ç™»é™†ç”¨æˆ·

   å› ä¸ºæ¯ä¸ªå¾®æœåŠ¡éƒ½ä¾èµ–äºè¿™ä¸ªé€šç”¨æ¨¡å—ï¼Œå› æ­¤ç›´æ¥åœ¨è¯¥æ¨¡å—ä¸­è·å–ç™»é™†ç”¨æˆ·ï¼Œé¿å…ä»£ç å†—ä½™

   ```java
   public class UserInfoInterceptor implements HandlerInterceptor {
       @Override
       public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
           //åœ¨æ§åˆ¶å™¨æ‰§è¡Œä¹‹å‰è·å–ç”¨æˆ·ä¿¡æ¯
           //1.è·å–ç™»é™†çš„ç”¨æˆ·ä¿¡æ¯
           String userInfo = request.getHeader("user-info");
           //2.åˆ¤æ–­æ˜¯å¦è·å–äº†ç”¨æˆ·ï¼Œå¦‚æœæœ‰å­˜å…¥ThreadLocal
           if (StrUtil.isNotBlank(userInfo)){
               UserContext.setUser(Long.valueOf(userInfo));
           }
           //3.æ”¾è¡Œï¼ˆæˆ‘ä»¬springmvcä¸­æ‹¦æˆªå™¨ä¸åšç™»é™†æ ¡éªŒï¼Œè¯·æ±‚ä¸€å¾‹æ”¾è¡Œï¼‰
           return true;
       }
       @Override
       public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
           //è§†å›¾æ¸²æŸ“å®Œæ¯•åã€‚ã€‚
           //æ¸…ç†ç”¨æˆ·ä¿¡æ¯
           UserContext.removeUser();
       }
   }
   ```

3. å†™å®Œæ‹¦æˆªå™¨åï¼Œæƒ³è¦ä»–ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€äº›é…ç½®ï¼Œæ·»åŠ æ‹¦æˆªå™¨åˆ°Iocä¸­å»ã€‚æˆ‘ä»¬ä¹‹å‰ç”¨çš„[xmlæ–¹å¼](/framework/SpringMVC02/SpringMVCå­¦ä¹ è®°å½•ç¬¬äºŒå¤©10-8.md#æ‹¦æˆªå™¨-interceptor) ï¼Œç°åœ¨ä½¿ç”¨Javaä»£ç æ–¹å¼   
   ```java
   @Configuration
   public class MvcConfig implements WebMvcConfigurer {
       @Override
       public void addInterceptors(InterceptorRegistry registry) {
           registry.addInterceptor(new UserInfoInterceptor())
   //                .addPathPatterns("/**") ä¸é…ç½®æ‹¦æˆªè·¯å¾„ï¼Œé»˜è®¤æ‹¦æˆªæ‰€æœ‰
           ;
       }
   }
   ```

4. ä¹‹å‰å­¦è¿‡[springbootè‡ªåŠ¨è£…é…åŸç†]()ï¼Œæˆ‘ä»¬è¿˜å¾—åœ¨spring.propertiesä¸­åŠ ä¸Šè¿™ä¸ªæ‹¦æˆªå™¨ï¼Œspringæ‰èƒ½å¸®æˆ‘ä»¬è‡ªåŠ¨è£…é…

   ```properties
   org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
     com.hmall.common.config.MyBatisConfig,\
     com.hmall.common.config.JsonConfig, \
     com.hmall.common.config.MvcConfig 
   ```

5. å¯åŠ¨æœåŠ¡ï¼Œå‘ç°æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬åŒ…æ‹¬ç½‘å…³åœ¨å†…çš„æ‰€æœ‰å¾®æœåŠ¡éƒ½ä¾èµ–äºè¿™ä¸ªé€šç”¨æ¨¡å—ï¼Œç„¶åå…¶ä»–çš„å¾®æœåŠ¡æœ‰springmvcçš„ä¾èµ–ï¼Œè€Œç½‘å…³æ˜¯æ²¡æœ‰springmvcçš„ä¾èµ–çš„ï¼Œå› æ­¤æˆ‘ä»¬çš„springmvcæ‹¦æˆªå™¨å¯¹ç½‘å…³æ¥è¯´å°±æ— æ³•æ³¨å…¥ã€‚æ‰€ä»¥æŠ¥é”™ã€‚è¿˜æ˜¯æ¶‰åŠåˆ°[springbootè‡ªåŠ¨è£…é…åŸç†]()ï¼Œæˆ‘ä»¬ä½¿ç”¨`@ConditionalOnClass`æ³¨è§£æ¥é…ç½®æ‹¦æˆªå™¨çš„ç”Ÿæ•ˆèŒƒå›´

   ```java
   @Configuration
   @ConditionalOnClass(DispatcherServlet.class)
   public class MvcConfig implements WebMvcConfigurer {
       @Override
       public void addInterceptors(InterceptorRegistry registry) {
           registry.addInterceptor(new UserInfoInterceptor())
   //                .addPathPatterns("/**") ä¸é…ç½®æ‹¦æˆªè·¯å¾„ï¼Œé»˜è®¤æ‹¦æˆªæ‰€æœ‰
           ;
       }
   }
   ```

   > è¿™æ ·é…ç½®åï¼Œç”±äºå…¶ä»–å¾®æœåŠ¡éƒ½æœ‰springmvcçš„ä¾èµ–ï¼Œè‡ªç„¶å°±æœ‰springmvcçš„æ ¸å¿ƒ-å‰ç«¯æ§åˆ¶å™¨çš„å­—èŠ‚ç æ–‡ä»¶ã€‚è€Œæˆ‘ä»¬çš„ç½‘å…³ç”±äºæ²¡æœ‰springmvcçš„ä¾èµ–ï¼Œä¹Ÿå°±æ²¡æœ‰å‰ç«¯æ§åˆ¶å™¨ï¼Œä¹Ÿå°±ä¸ä¼šæ¥åŠ è½½è¿™ä¸ªæ‹¦æˆªå™¨äº†ã€‚è¿™æ ·ç½‘å…³å¯åŠ¨æ—¶å°±ä¸ä¼šæŠ¥é”™äº†ã€‚

## å¾®æœåŠ¡é—´ä¼ é€’ç”¨æˆ· - OpenFeign

åŸºäºOpenFeignçš„`RequestInterceptor`æ¥å£æ¥å®ç°å¾®æœåŠ¡é—´çš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’ã€‚

![](img/2023-12-16_17-17.png)

å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨é€šè¿‡openfeignæ¥å®ç°ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä»UserContextä¸­è·å–ç”¨æˆ·ä¿¡æ¯å‘¢ï¼Ÿ

ä¹‹å‰æˆ‘ä»¬çš„UserInfoInterceptorè·å–ç”¨æˆ·ä¿¡æ¯æ˜¯ä»ç½‘å…³çš„**è¯·æ±‚å¤´**ä¸­è·å–å¹¶ä¿å­˜åˆ°UserContextä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¾®æœåŠ¡çš„æ¯æ¬¡äº’ç›¸è°ƒç”¨ï¼Œéƒ½ä¼šä»è¿™æ¬¡è°ƒç”¨è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šä»ç½‘å…³åˆ°å¾®æœåŠ¡1ä¹‹é—´çš„è°ƒç”¨ï¼Œè¯·æ±‚å¤´ä¸­ æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œè‡ªç„¶å¯ä»¥è·å–åˆ°å­˜å…¥UserContextä¸­ã€‚é‚£ä¹ˆä»å¾®æœåŠ¡1åˆ°å¾®æœåŠ¡2çš„è°ƒç”¨ï¼Œæ˜¯openfeignå¸®æˆ‘ä»¬å®Œæˆçš„ï¼Œæˆ‘ä»¬çŸ¥é“å…·ä½“è¿‡ç¨‹ï¼Œè¿™é‡Œé¢çš„è¯·æ±‚å¤´é‡Œæ˜¯æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯çš„ã€‚æ‰€ä»¥å¾®æœåŠ¡2å°±æ— æ³•æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚é‚£æˆ‘ä»¬è¦å®ç°çš„ç›®æ ‡å°±æ˜¯è®©å¾®æœåŠ¡1åˆ°å¾®æœåŠ¡2è¿™ä¸ªè¿‡ç¨‹çš„è¯·æ±‚å¤´ä¸­æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œä¸ä»…æ˜¯è¿™æ ·ï¼Œè¿˜å¾—ä¿è¯å¾®æœåŠ¡2åˆ°å¾®æœåŠ¡3ï¼Œå¾®æœåŠ¡3åˆ°å¾®æœåŠ¡4 ... ä»–ä»¬ä¹‹é—´çš„è¯·æ±‚å¤´ä¸­éƒ½æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™æ ·æ‰è¡Œã€‚

è¦å®ç°ä¸Šè¿°ç›®çš„ï¼Œéš¾é“æˆ‘ä»¬è¦ä¸€ä¸ªä¸ªæ‰‹å†™è¯·æ±‚å¤´å—ï¼Ÿ å…¶å®openfeignç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¥å£ï¼š`RequestInterceptor`è¯·æ±‚æ‹¦æˆªå™¨ï¼Œå¯ä»¥æ‹¦æˆªæ‰€æœ‰feignå®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚å¼€å§‹å‰éƒ½ä¼šæ‰§è¡Œè¿™ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ¥å£æ¥è·å–è¯·æ±‚å¤´ä¸­çš„ä¿¡æ¯ã€‚

å› ä¸ºç½‘å…³åˆ°å¾®æœåŠ¡1çš„è¿‡ç¨‹ï¼Œè¯·æ±‚å¤´ä¸­åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥UserContextä¸­ä¿å­˜çš„æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ‹¦æˆªå™¨ä¸­å°†è¿™ä¸ªUserContextä¸­çš„ä¿¡æ¯å­˜å…¥è¯·æ±‚å¤´ä¸­ï¼Œè¿™æ ·ï¼Œä¹‹åçš„æ¯æ¬¡è¯·æ±‚éƒ½è°ƒç”¨è¿™ä¸ªè¿‡ç¨‹ï¼Œé‚£ä¹ˆæ¯ä¸ªè¯·æ±‚å¤´å°±éƒ½æœ‰ç”¨æˆ·ä¿¡æ¯äº†ã€‚

> æˆ‘ä»¬åœ¨hm-apiä¸­æ–°å¢ä¸€ä¸ªé…ç½®ç±»æˆ–è€…åœ¨ç°æœ‰é…ç½®ç±»ä¸­å†™éƒ½è¡Œã€‚å› ä¸ºä»£ç æ¯”è¾ƒç®€å•ï¼Œç›´æ¥åœ¨ç°æœ‰é…ç½®ç±»ä¸­å†™

```java
public class DefaultFeignConfig {
    @Bean
    public Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }

    @Bean
    public RequestInterceptor userInfoInterceptor(){
        return new RequestInterceptor() {   //å‡½æ•°å¼æ¥å£ï¼Œå¯ä»¥è½¬ä¸ºlambdaå½¢å¼
            @Override
            public void apply(RequestTemplate template) {
                Long userId = UserContext.getUser();
                if (userId!=null){
                    template.header("user-info", userId.toString()); //è®¾ç½®è¯·æ±‚å¤´
                }
            }
        };
    }
}
```

> è¿™æ ·ï¼Œç½‘å…³åˆ°å¾®æœåŠ¡é—´æ¯æ¬¡è°ƒç”¨éƒ½èƒ½è·å–ç”¨æˆ·ä¿¡æ¯
>
> 1. ç½‘å…³è¯·æ±‚åˆ°ç¬¬ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¯·æ±‚å¤´ä¸­æœ‰ç”¨æˆ·ä¿¡æ¯
> 2. è¯¥è¯·æ±‚è¢«springmvcæ‹¦æˆªï¼Œç„¶åä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¿å­˜åˆ°UserContexté‡Œ
> 3. ç¬¬ä¸€ä¸ªå¾®æœåŠ¡å‘ç¬¬äºŒä¸ªå¾®æœåŠ¡å‘è¯·æ±‚ï¼Œè¯¥è¯·æ±‚è¢« feignæ‹¦æˆªå™¨æ‹¦æˆªï¼Œä»UserContexté‡Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å…¥è¯·æ±‚å¤´ä¸­
> 4. è¯¥è¯·æ±‚åˆè¢«springmvcæ‹¦æˆªï¼Œä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å…¥UserContexté‡Œä¾›ç¬¬äºŒä¸ªå¾®æœåŠ¡ä½¿ç”¨ã€‚ã€‚ã€‚
>
> > å°±è¿™æ ·ï¼Œspringmvcæ‹¦æˆªå™¨å’Œfeignæ‹¦æˆªå™¨ç›¸äº’é…åˆï¼Œè®©å¤§å®¶éƒ½èƒ½è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚ğŸ¥³

