# é›†åˆå»é‡

å¦‚æœæ˜¯å•çº¯å¯¹ä¸€ä¸ªå¯¹è±¡æ•´ä½“ï¼Œæˆ–è€…æ˜¯å…¶ä»–åŒ…è£…ç±»å‹çš„é›†åˆè¿›è¡Œå»é‡ï¼Œå¯ä»¥ä½¿ç”¨HashSetæˆ–TreeSetã€‚ä½¿ç”¨setå»é‡éœ€è¦æ³¨æ„ï¼ŒHashSetå»é‡æ˜¯é€šè¿‡å¯¹è±¡çš„equalsæ–¹æ³•æ¥è¿›è¡ŒåŒºåˆ†çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦é‡å†™å¯¹è±¡çš„equalsæ–¹æ³•ã€‚ä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ— ä¾µå…¥çš„æ–¹å¼:

- HashSetæ ¹æ®æŸä¸€å­—æ®µå»é‡

```java
// ä½¿ç”¨ HashSet è®°å½•å·²å‡ºç°çš„ userId
Set<Integer> seenUserIds = new HashSet<>();
List<User> uniqueUsers = users.stream()
        .filter(user -> seenUserIds.add(user.userId)) // å¦‚æœ userId ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
        .collect(Collectors.toList());
```

- TreeSet

```java
// è‡ªå®šä¹‰ Comparatorï¼Œåªæ¯”è¾ƒ userIdï¼Œå®ç°å»é‡
Comparator<User> comparator = (u1, u2) -> Integer.compare(u1.userId, u2.userId);



// ä½¿ç”¨ TreeSet çš„è‡ªå®šä¹‰ Comparator
TreeSet<User> uniqueUsers = new TreeSet<>(
        Comparator.comparingInt(user -> user.userId) // æ ¹æ® userId å»é‡
);

uniqueUsers.addAll(users); 
```

å¦‚æœæ˜¯æƒ³è¦æ ¹æ®å¯¹è±¡ä¸­æŸä¸ªå­—æ®µæ¥è¿›è¡Œå»é‡ï¼Œå¯ä»¥ä½¿ç”¨Streamä¸­çš„toMapæ–¹æ³•, åˆ©ç”¨mapçš„é”®ä¸å¯é‡å¤çš„ç‰¹æ€§ï¼Œæ›²çº¿æ•‘å›½:

```java
List<User> distinctUsers = users.stream()
    .collect(Collectors.toMap(
            user -> user.userId, // ä½¿ç”¨ userId ä½œä¸ºé”®
            Function.identity(), // ä½¿ç”¨ User å¯¹è±¡ä½œä¸ºå€¼
            (existing, replacement) -> existing // å¦‚æœå†²çªï¼Œä¿ç•™ç°æœ‰å¯¹è±¡
    ))
    .values()
    .stream()
    .collect(Collectors.toList());
```

# Arrays.asListæ³¨æ„äº‹é¡¹

ä½¿ç”¨asListå°†å…ƒç´ è½¬ä¸ºlistæ—¶ï¼Œè¦æ³¨æ„ï¼Œè½¬æ¢åçš„listæ²¡æœ‰addå’Œremoveæ–¹æ³•ã€‚å› æ­¤æ— æ³•æ‰§è¡Œaddå’Œremoveæ“ä½œã€‚å¦åˆ™ä¼šæŠ¥é”™ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹æ“ä½œè§£å†³ï¼š

```java
List<Object> list = new ArrayList<>(Arrays.asList(item)); 
```

# Transactionalæ³¨æ„äº‹é¡¹

åœ¨é¡¹ç›®ä¸­é‡åˆ°ä¸€ä¸ªbugã€‚å°±æ˜¯ä»¥ä¸‹ä»£ç ä¸­ï¼Œé‚®ä»¶å‘é€çš„é€»è¾‘æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚ä½†æ˜¯æ•´ä¸ª `apply` æ–¹æ³•è¢« `@Transactional` æ³¨è§£æ ‡è®°ï¼Œ**è¿™ä¸ªæ–¹æ³•ä¸­æ‰€æœ‰çš„æ•°æ®åº“æ“ä½œéƒ½ä¼šç­‰åˆ°äº‹åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰çœŸæ­£æäº¤åˆ°æ•°æ®åº“**ã€‚å› æ­¤å°±å¯¼è‡´å½“ä»£ç æ‰§è¡Œåˆ°é‚®ä»¶å‘é€çš„é€»è¾‘åï¼Œé‚®ä»¶å‘é€é€»è¾‘ä¸­å¦‚æœéœ€è¦ä»æ•°æ®åº“è·å–æ•°æ®ï¼Œä¼šæ— æ³•è·å–åˆ°ï¼Œå› ä¸ºæ­¤æ—¶å¯èƒ½å¼‚æ­¥çš„ä»»åŠ¡æ‰§è¡Œåˆ°è·å–æ•°æ®é‚£ä¸€æ­¥çš„æ—¶å€™ï¼Œä¸šåŠ¡ä»£ç ä¸­çš„äº‹åŠ¡å¹¶æœªæäº¤ï¼Œå¯¼è‡´æ•°æ®æ²¡æœ‰å…¥åº“ã€‚

ä¸šåŠ¡ä»£ç ï¼š

```java
@Override  
@Transactional(rollbackFor = Exception.class)  
public Boolean apply(MeetingReservationDTO dto) {  
    //åˆæ³•æ€§æ ¡éªŒ  
    meetingReservationValidate(dto);  
    MeetingReservationDO meeting = MeetingReservationConverter.INSTANCE.convertMeetingReservationDTO2DO4Insert(dto);  
    //æ•°æ®æ’å…¥
    meetingReservationMapper.insert(meeting);  
    //æ‰§è¡Œé‚®ä»¶å‘é€é€»è¾‘
    meetingMailProducer.sendMeetingApplyMail(emailList, noEnrollUsers, meeting);  
    return true;  
}
```

producerï¼š

```java
  
public void sendMeetingApplyMail(List<String> emailList, List<String> csMailList, MeetingReservationDO meeting) {  
    MeetingSendMessage meetingSendMessage = new MeetingSendMessage().setMeeting(meeting)  
            .setEmailList(removeSystemEmailFromList(emailList))  
            .setEnums(EmailSendTypeEnums.MEETING_APPLY);  
	applicationContext.publishEvent(meetingSendMessage);  
}
```

consumerï¼š

```java
@EventListener  
@Async // Spring Event é»˜è®¤åœ¨ Producer å‘é€çš„çº¿ç¨‹ï¼Œé€šè¿‡ @Async å®ç°å¼‚æ­¥  
public void onMeetingSendMessage(MeetingSendMessage message) {  
    SendEmailHandler handler = sendTypeHandlerFactory.getHandler(enums);  
	handler.sendMeetingEmail(message.getEmailList(), message.getCsMailList(), message.getMeeting());  
}
```

è§£å†³æ–¹æ¡ˆï¼š

åœ¨äº‹åŠ¡æäº¤ä¹‹åæ‰§è¡Œé‚®ä»¶å‘é€é€»è¾‘

 - å¯ä»¥è€ƒè™‘ä½¿ç”¨ `TransactionSynchronizationManager.registerSynchronization` å®ç° `afterCommit` æ–¹æ³•ï¼Œè®©é‚®ä»¶å‘é€çš„é€»è¾‘åœ¨äº‹åŠ¡æäº¤ä¹‹åæ‰§è¡Œ

```java
TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {  
    @Override  
    public void afterCommit() {  
	    /* ... */
	    meetingMailProducer.sendMeetingApplyMail(emailList, noEnrollUsers, meeting);  
    }});
```

   - ä¹Ÿå¯ä»¥æ‰‹åŠ¨æäº¤äº‹åŠ¡ã€‚ä½†æ˜¯å¦‚æœæ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼Œé‚£ä¹ˆ `@Transactional` æ³¨è§£ä¼šå¤±æ•ˆï¼Œå°±éœ€è¦æ‰‹åŠ¨å›æ»šäº‹åŠ¡ã€‚

```java
//æ³¨å…¥äº‹åŠ¡ç®¡ç†å™¨
@Autowired 
private PlatformTransactionManager transactionManager;

public void doSomething() {
	//å®šä¹‰äº‹åŠ¡ä¼ æ’­ç±»å‹å’Œè·å–äº‹åŠ¡çŠ¶æ€
	DefaultTransactionDefinition def = new DefaultTransactionDefinition();  
	def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED); 
	TransactionStatus status = transactionManager.getTransaction(def);
	
	try {
		/* ... */
		//æäº¤äº‹åŠ¡
		transactionManager.commit(status);
	} catch (Exception e) {
		//å›æ»šäº‹åŠ¡
		transactionManager.rollback(status);
	}
}
```

# BUGæ’æŸ¥æ€è·¯

## 500å¼‚å¸¸

1. æ‰“å¼€æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æŠ¥é”™çš„æ¥å£æ˜¯å“ªä¸ª
2. è§‚å¯Ÿå‘é€çš„è¯·æ±‚ï¼Œæ˜¯å¦æœ‰é‡å¤è¯·æ±‚ï¼Ÿè€ƒè™‘éƒ¨åˆ†æ¥å£åœ¨é‡å¤è°ƒç”¨çš„æƒ…å†µä¸‹æ˜¯å¦ä¼šå‡ºç°æ— æ³•é¢„æ–™çš„å¼‚å¸¸ï¼Ÿ
3. è§‚å¯Ÿpayloadå’Œresponseï¼Œè§‚å¯Ÿæ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
4. æ‰“å¼€åç«¯ä»£ç ï¼Œè¿›è¡Œè°ƒè¯•ï¼Œæ’é”™

# æ—¥æœŸè½¬æ¢

## Javaä¸­çš„æ—¥æœŸè½¬æ¢

1. **`Date`** è½¬ **`LocalDateTime`**

   é¦–å…ˆå°†dateè½¬ä¸º**`Instant`**ï¼Œå†æŒ‡å®šæ—¶åŒº

   ```java
   date.toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime();
   ```

2. **`LocalDateTime`** è½¬ **`Date`**

   **`LocalDateTime`** å…ˆæŒ‡å®šæ—¶åŒºï¼Œè½¬ä¸º **`Instant`**, å†é€šè¿‡fromè½¬ä¸ºdate

   ```java
   Date.from(localDateTime.atZone(ZoneId.systemDefault()).toInstant());
   ```

3. **`LocalDate` to `Date`**

   `LocalDate` åªåŒ…å«æ—¥æœŸä¿¡æ¯ï¼Œæ²¡æœ‰æ—¶é—´ä¿¡æ¯ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `atStartOfDay()` æ–¹æ³•å°†å®ƒè®¾ç½®ä¸ºå½“å¤©å¼€å§‹çš„æ—¶é—´ (00:00:00)ï¼Œç„¶åæŒ‰ç…§ä¸ `LocalDateTime` ç›¸åŒçš„æ–¹å¼è½¬æ¢ä¸º `Date`ã€‚ åŒæ ·ï¼Œè¿™é‡Œä¹Ÿä½¿ç”¨äº†ç³»ç»Ÿé»˜è®¤æ—¶åŒºã€‚

   ```java
   Date.from(localDate.atStartOfDay(ZoneId.systemDefault()).toInstant());
   ```

# LocalDateTimeåºåˆ—åŒ–é—®é¢˜

LocalDateTimeç±»å‹æ•°æ®åœ¨åºåˆ—åŒ–ä¸ºJSONæ•°æ®æ—¶ï¼Œä¼šè¢«é»˜è®¤è½¬åŒ–ä¸ºæ—¶é—´æˆ³çš„æ ¼å¼ã€‚æƒ³è¦è®©å…¶ä»¥æ­£å¸¸æ ¼å¼è¾“å‡ºï¼Œå¯ä»¥ä½¿ç”¨ `@JsonFormat` æ³¨è§£ã€‚

```java
@Data
public class MeetingJobLogPageReqVO extends PageParam {
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime executeTime;
}
```

# åºåˆ—åŒ–é—®é¢˜

```java
org.quartz.JobPersistenceException: Couldn't store trigger 'DEFAULT.roomNoticeJobTrigger:1886978075499233282' for 'DEFAULT.roomNoticeJob:1886978075499233282' job:Couldn't retrieve job because the BLOB couldn't be deserialized: com.gree.gie.boot.module.oa.meeting.dal.dataobject.MeetingRoomReservationDO; local class incompatible: stream classdesc serialVersionUID = -926631847671346518, local class serialVersionUID = 4064805396981658726
```

å®šæ—¶ä»»åŠ¡çš„æŒä¹…åŒ–å¼‚å¸¸ã€‚å› ä¸ºå®ä½“ç±»å‘ç”Ÿè¿‡å˜åŠ¨ï¼Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œç”±äºæ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šåºåˆ—åŒ–idï¼Œè€Œå®ä½“ç±»å‘ç”Ÿå˜åŠ¨ï¼ˆå­—æ®µä¿®æ”¹ï¼‰åï¼Œç±»hashå€¼å‘ç”Ÿæ”¹å˜ï¼Œåºåˆ—åŒ–idä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚æ‰€ä»¥quartzæ— æ³•æ ¹æ®ä¹‹å‰æ—§çš„åºåˆ—åŒ–idæ‰¾åˆ°å¯¹åº”çš„å®ä½“ç±»ã€‚

è§£å†³æ–¹æ¡ˆï¼šä¸ºå®ä½“ç±»æ‰‹åŠ¨å®šä¹‰åºåˆ—åŒ–id

```java
public class MeetingRoomReservationDO extends BaseDO implements Serializable {
    private static final long serialVersionUID = -926631847671346518L;
    //...
}
```

>[!NOTE]
>
>å»ºè®®æ‰€æœ‰å¯åºåˆ—åŒ–çš„ç±»éƒ½æ˜¾å¼å£°æ˜serialVersionUIDçš„å€¼ï¼Œå› ä¸ºé»˜è®¤çš„serialVersionUIDè®¡ç®—å¯¹ç±»çš„è¯¦ç»†ä¿¡æ¯éå¸¸æ•æ„Ÿï¼Œè¿™äº›è¯¦ç»†ä¿¡æ¯å¯èƒ½å› ç¼–è¯‘å™¨å®ç°è€Œå¼‚ã€‚å› æ­¤åœ¨ååºåˆ—åŒ–æœŸé—´å¯èƒ½å¯¼è‡´æ„å¤–çš„é”™è¯¯(InvalidClassException)ã€‚å› æ­¤ä¸ºäº†ä¿è¯ä¸åŒjavaç¼–è¯‘å™¨ååºåˆ—ç»“æœä¸€è‡´ï¼Œå¯åºåˆ—åŒ–çš„ç±»å¼ºçƒˆå»ºè®®æ˜¾ç¤ºå£°æ˜serialVersionUIDçš„å€¼ï¼Œå¹¶å»ºè®®ä½¿ç”¨privateä¿®é¥°ç¬¦ï¼Œå› ä¸ºæ­¤å£°æ˜ä»…é€‚ç”¨äºç«‹å³å£°æ˜çš„ç±»ï¼Œè€Œä¸é€‚ç”¨äºå…¶å­ç±»ã€‚

# æ•°æ®åº“å­—æ®µæ’å…¥åˆ—è¡¨æ•°æ®

æ•°æ®åº“ä¸­å­—æ®µæ˜¯ `varchar` ï¼Œè€Œå¸Œæœ›å­˜å‚¨ä¸€ä¸ªå½¢å¦‚ `[1,2323,545]` çš„åˆ—è¡¨æ•°æ®ã€‚ å®ä½“ç±»åº”è¯¥ç›´æ¥ä¸º `List<Integer>` ï¼Œå¹¶ç”¨æ³¨è§£ `@TableField(typeHandler = JacksonTypeHandler.class)` æ ‡è®°ã€‚

```java
@TableField(typeHandler = JacksonTypeHandler.class)
private List<Long> visibility;
```

ç„¶ååœ¨@TableNameæ³¨è§£ä¸Šå¼€å¯autoResultMapå±æ€§å³å¯ã€‚

```java
@TableName(value = "oa_meeting_room_reservation", autoResultMap = true)
```

# è®¡ç®—æ—¶é—´å·®

```java
ChronoUnit.MINUTES.between(start, end)
```

# Quartz

ä¸‰ä¸ªé‡è¦è§’è‰²ï¼š
- job  å…·ä½“çš„ä»»åŠ¡
- trigger  è§¦å‘å™¨ï¼Œå†³å®šäº†jobå°†åœ¨ä½•æ—¶è§¦å‘
- scheduler  è°ƒåº¦å™¨ï¼Œæ˜¯jobå’Œtriggerçš„ç®¡ç†è€…å’Œè°ƒåº¦è€…ï¼Œå¯ä»¥è·å–è§¦å‘å™¨çŠ¶æ€ï¼Œè°ƒç”¨è§¦å‘å™¨ï¼Œå–æ¶ˆè§¦å‘å™¨ã€‚å®šæ—¶ä»»åŠ¡çš„ä¸€åˆ‡æ“ä½œéƒ½æ˜¯ä½¿ç”¨ `scheduler` å®Œæˆçš„

å…¶ä»–çš„çœ‹æºç å³å¯ï¼Œæºç ç®€æ´æ˜“æ‡‚ã€‚

# Server Send Event

SSEçš„æ ¸å¿ƒæ˜¯ `SseEmitter` ï¼Œç”¨ä»¥å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚

å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šä»¥ `text/event-stream` çš„MIMEæ ¼å¼è¿”å›ä¸€ä¸ª `SseEmitter` ç»™å®¢æˆ·ç«¯ï¼Œä¹‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±ä¼šä¸€ç›´ç»´æŒè¿™ä¸ªè¿æ¥ï¼Œç›´åˆ°æ—¶é—´è¾¾åˆ° `SseEmitter` è®¾å®šçš„è¿‡æœŸæ—¶é—´ã€‚

SSEå®è·µï¼š

1. å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨ä¸€æ¬¡æœåŠ¡å™¨çš„æ¥å£æ¥å»ºç«‹SSEçš„è¿æ¥ã€‚
2. æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚

```java
@Component
@Slf4j
@RequiredArgsConstructor
public class SseEmitterHolder {

    private final Map<String, SseEmitterUTF8> emitterPool = new ConcurrentHashMap<>();
    private final Map<String, Boolean> emitterStatus = new ConcurrentHashMap<>();
    private final MeetingRoomManageService meetingRoomManageService;

    private final ExecutorService executorService = new ThreadPoolExecutor(
            8,
            20,
            60L,
            TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(100),
            new ThreadPoolExecutor.CallerRunsPolicy()
    );
    
	//è¯¥æ–¹æ³•ç”¨ä»¥å’Œå®¢æˆ·ç«¯å»ºç«‹sseè¿æ¥ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º1å°æ—¶
    public SseEmitterUTF8 getOrCreateEmitter(String auth) {
        return emitterPool.computeIfAbsent(auth, k -> {
            SseEmitterUTF8 sseEmitterUTF8 = new SseEmitterUTF8(60 * 60 * 1000L);
            sseEmitterUTF8.onCompletion(() -> {
                emitterPool.remove(auth);
                emitterStatus.put(auth, true);
            });
            sseEmitterUTF8.onTimeout(() -> {
                emitterPool.remove(auth);
                emitterStatus.put(auth, true);
            });
            emitterStatus.put(auth, false);
            return sseEmitterUTF8;
        });
    }

    //è¯¥æ–¹æ³•ç”¨ä»¥å¹¿æ’­æ¶ˆæ¯ï¼Œå°†æ•°æ®æ¨é€ç»™æ‰€æœ‰sseå®¢æˆ·ç«¯
    public void broadcastData() {
        log.debug("SSEå¹¿æ’­è¯·æ±‚ç”¨æˆ·: {}", Objects.requireNonNull(getLoginUserId()));
        List<JSONObject> data = meetingRoomManageService.getMeetingRoomDashBoard();  //è·å–æ•°æ®
        Iterator<Map.Entry<String, SseEmitterUTF8>> iterator = emitterPool.entrySet().iterator();  //éå†emitterè¿æ¥æ± 
        while (iterator.hasNext()) { 
            Map.Entry<String, SseEmitterUTF8> entry = iterator.next();
            String key = entry.getKey();
            SseEmitterUTF8 emitter = entry.getValue();
            if (emitterStatus.getOrDefault(key, true)) {
                log.debug("è·³è¿‡å·²å®Œæˆæˆ–æ–­å¼€çš„è¿æ¥: {}", key);
                iterator.remove();
                continue;
            }
            executorService.submit(() -> {
                try {
                    //å‘è¿æ¥æ± ä¸­çš„æ‰€æœ‰emitterå®ä¾‹æ¨é€æ¶ˆæ¯
                    emitter.send(SseEmitterUTF8.event()
                            .data(data, MediaType.APPLICATION_JSON)
                            .reconnectTime(5 * 1000L));
                } catch (IOException e) {
                    log.debug("å®¢æˆ·ç«¯è¿æ¥å·²å…³é—­ {}: {}", key, e.getMessage());
                } catch (IllegalStateException e) {
                    log.debug("è¿æ¥çŠ¶æ€å¼‚å¸¸ {}: {}", key, e.getMessage());
                } catch (Throwable e) {
                    log.debug("SSEæ¶ˆæ¯å‘é€å¼‚å¸¸ {}: {}", key, e.getMessage());
                } finally {
                    if (emitterStatus.getOrDefault(key, true)) {
                        iterator.remove();
                    }
                }
            });
        }
    }
}

```

## ä¸­æ–‡ä¹±ç 

`SseEmitter` åœ¨SpringMVCä¸­é»˜è®¤æ˜¯ISOç¼–ç æ ¼å¼ï¼Œæ­¤æ—¶è‹¥å®¢æˆ·ç«¯é‡‡ç”¨çš„ç¼–ç æ ¼å¼æ˜¯UTF-8ï¼Œåˆ™ä¼šå¯¼è‡´ä¸­æ–‡ä¹±ç ã€‚å› æ­¤éœ€è¦é‡å†™ `SseEmitter`  çš„ `extendResponse` æ–¹æ³•ï¼Œæ‰‹åŠ¨è®¾ç½®å…¶ç¼–ç æ ¼å¼ã€‚

```java
@Data
public class SseEmitterUTF8 extends SseEmitter {

    public SseEmitterUTF8() {
    }

    public SseEmitterUTF8(Long timeout) {
        super(timeout);
    }

    @Override
    protected void extendResponse(@NotNull ServerHttpResponse outputMessage) {
        super.extendResponse(outputMessage);
        HttpHeaders headers = outputMessage.getHeaders();
        headers.setContentType(new MediaType(MediaType.TEXT_EVENT_STREAM, StandardCharsets.UTF_8));
    }
}
```

# å¹¶å‘ç¼–ç¨‹

ä½¿ç”¨ `ThreadPoolExecutor` æ¥æ˜¾å¼åˆ›å»ºçº¿ç¨‹æ± ã€‚å› ä¸ºè¿™æ ·å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§è¿æ¥æ•°ï¼Œæ‹’ç»ç­–ç•¥ç­‰ã€‚ä¸è¦ä½¿ç”¨ `Executors` å·¥å…·ç±»çš„é™æ€æ–¹æ³•ä¾‹å¦‚ `newFixedThreadPool` æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚è™½ç„¶è¿™æ ·æ›´åŠ æ–¹ä¾¿ï¼Œä½†æ˜¯è¿™æ ·åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹æ± ä¸åˆ©äºç»´æŠ¤å’Œæ‹“å±•ã€‚`newFixedThreadPool` çº¿ç¨‹æ± æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯**æ— ç•Œé˜»å¡é˜Ÿåˆ—**ï¼Œå®¹æ˜“é€ æˆå†…å­˜æº¢å‡ºã€‚ä»¥ä¸‹æ˜¯ `newFixedThreadPool` æºç ï¼š

```java
public static ExecutorService newFixedThreadPool(int nThreads) {
    return new ThreadPoolExecutor(nThreads, nThreads,
                                  0L, TimeUnit.MILLISECONDS,
                                  new LinkedBlockingQueue<Runnable>());
}
```

åº”å½“ä½¿ç”¨ `ThreadPoolExecutor` æ¥æ˜¾å¼åˆ›å»ºçº¿ç¨‹æ± ï¼š

```java
private final ExecutorService executorService = new ThreadPoolExecutor(
        8,
        20,
        60L,
        TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(100),  //æœ‰ç•Œé˜»å¡é˜Ÿåˆ—
        new ThreadPoolExecutor.CallerRunsPolicy()  //æ‹’ç»ç­–ç•¥
);
```

çº¿ç¨‹æ± ä½¿ç”¨ï¼š

```java
//æäº¤ä»»åŠ¡
executorService.submit(() -> {
    emitter.send(SseEmitterUTF8.event()
            .data(data, MediaType.APPLICATION_JSON)
            .reconnectTime(5 * 1000L));
});
```

## çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥

- DiscardOldestPolicyï¼šä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡ï¼›
- CallerRunsPolicyï¼šåŒæ­¥è°ƒç”¨, é‡åˆ°æ–°ä»»åŠ¡ä¼šå°†ä»»åŠ¡è¿”å›ç»™è°ƒç”¨è€…çº¿ç¨‹ï¼Œè®©å…¶æ‰§è¡Œï¼›
- AbortPolicyï¼šä¸¢å¼ƒæ–°ä»»åŠ¡å¹¶æŠ›å‡ºå¼‚å¸¸ï¼›
- DiscardPolicyï¼šä¸¢å¼ƒæ–°ä»»åŠ¡ï¼›

## å¼‚æ­¥ç¼–æ’

[å‚è€ƒæ–‡ç« ğŸ‘ˆ](https://www.cnblogs.com/kevin-ying/p/14383380.html)

ä½¿ç”¨ï¼š

```java
CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {
    int a = 10 / 2;
    System.out.println("å½“å‰çº¿ç¨‹"+Thread.currentThread().getId()+"------å½“å‰ç»“æœ" + a);
    return a;
}).whenComplete((result,exception)->{
    System.out.println("å¼‚æ­¥ä»»åŠ¡å®Œæˆäº†ï¼Œç»“æœï¼š"+result);
    System.out.println("å¼‚æ­¥ä»»åŠ¡å¼‚å¸¸ï¼š"+exception);
});
```

# å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„ä¸Šä¸‹æ–‡ä¼ é€’é—®é¢˜

ä»Šå¤©çº¿ä¸Šå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼ŒåŒäº‹åæ˜ è¯´ä¼šè®®é¢„çº¦æ—¶å‘é€çš„é‚®ä»¶ä¸­æ˜¾ç¤ºçš„é¢„çº¦äººä¿¡æ¯ä¸å¯¹ï¼Œæˆ‘ä¸€çœ‹ï¼Œæ˜æ˜ä¼šè®®æ˜¯Aé¢„çº¦çš„ï¼Œé‚®ä»¶ä¸­å´æ˜¾ç¤ºæ˜¯Bã€‚è¿™ä¸ªæƒ…å†µè®©æˆ‘éå¸¸å¥½å¥‡ï¼Œåæ¥ç»è¿‡æ€è€ƒå’Œæ’æŸ¥ï¼Œå¤§è‡´å°†é—®é¢˜é”å®šåœ¨å¹¶å‘å®‰å…¨çš„é—®é¢˜ä¸Šã€‚å› ä¸ºé¢„çº¦ä¼šè®®çš„ä¸šåŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‘é€é‚®ä»¶æ˜¯äº¤ç»™çº¿ç¨‹æ± æ¥æ‰§è¡Œçš„ï¼Œåœ¨å¤„ç†é‚®ä»¶å‘é€çš„é€»è¾‘ä¸­æœ‰é€šè¿‡ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯çš„æ“ä½œï¼Œæˆ‘åˆæ­¥åˆ¤æ–­ï¼Œå¯èƒ½æ˜¯ç”±äºä¸»çº¿ç¨‹å’Œçº¿ç¨‹æ± ä¸­æ‰§è¡Œé‚®ä»¶å‘é€çº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡æ²¡æœ‰æŒ‰é¢„æœŸä¼ é€’å¯¼è‡´çš„é—®é¢˜ã€‚

```java
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean apply(MeetingReservationDTO dto) {
        //...ä¸»ä¸šåŠ¡é€»è¾‘
        registerSynchronization(new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                //é‚®ä»¶å‘é€
                CompletableFuture.runAsync(() -> {
                    meetingMailProducer.sendMeetingApplyMail();
                }, executor);
            }
        });
        return true;
    }
```

## è§£å†³æ–¹æ¡ˆ

1. ç›´æ¥ä¼ é€’ç”¨æˆ·id

   åœ¨è°ƒç”¨å‘é€é‚®ä»¶æ–¹æ³•æ—¶å°†ä¸»çº¿ç¨‹ä¸­çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ã€‚

2. ä½¿ç”¨ `transmittable-thread-local` ä½œä¸ºå­˜å‚¨ç”¨æˆ·ä¸Šä¸‹æ–‡çš„å®¹å™¨ï¼Œé…åˆ`TtlExcutors`  æˆ– `TtlRunnable` å®ç°ä¸Šä¸‹æ–‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„ä¼ é€’ã€‚

   ```java
   public class TransmittableThreadLocalSecurityContextHolderStrategy implements SecurityContextHolderStrategy {
   
       /**
        * ä½¿ç”¨ TransmittableThreadLocal ä½œä¸ºä¸Šä¸‹æ–‡
        */
       private static final ThreadLocal<SecurityContext> CONTEXT_HOLDER = new TransmittableThreadLocal<>();
   
       @Override
       public void clearContext() {
           CONTEXT_HOLDER.remove();
       }
   
       @Override
       public SecurityContext getContext() {
           SecurityContext ctx = CONTEXT_HOLDER.get();
           if (ctx == null) {
               ctx = createEmptyContext();
               CONTEXT_HOLDER.set(ctx);
           }
           return ctx;
       }
   
       @Override
       public void setContext(SecurityContext context) {
           Assert.notNull(context, "Only non-null SecurityContext instances are permitted");
           CONTEXT_HOLDER.set(context);
       }
   
       @Override
       public SecurityContext createEmptyContext() {
           return new SecurityContextImpl();
       }
   
   }
   ```

   ```java
   //è‡ªå®šä¹‰çš„ç”¨æˆ·ä¸Šä¸‹æ–‡
   private static final TransmittableThreadLocalSecurityContextHolderStrategy SECURITY_STRATEGY =
               new TransmittableThreadLocalSecurityContextHolderStrategy();
   
   public static Long getLoginUserId() {
       SecurityContext ctx = SECURITY_STRATEGY.getContext();
       if (ctx == null) {
           return null;
       }
       Authentication authentication = ctx.getAuthentication();
       if (authentication == null) {
           return null;
       }
       return authentication.getPrincipal() instanceof LoginUser
               ? ((LoginUser) authentication.getPrincipal()).getId() : null;
   }
   ```

   ```java
   //åˆ›å»ºçº¿ç¨‹æ± 
   public ExecutorService createExecutor(String name, int corePoolSize, int maximumPoolSize,
                                            long keepAliveTime, TimeUnit unit,
                                            BlockingQueue<Runnable> workQueue) {
       ThreadPoolExecutor executor = new ThreadPoolExecutor(
               corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
               new ThreadFactoryBuilder().setNameFormat(name + "-%d").build(),
               new ThreadPoolExecutor.CallerRunsPolicy()
       );
       ExecutorService executorService = TtlExecutors.getTtlExecutorService(executor);
       executors.put(name, executorService);
       return executorService;
   }
   ```

3. ä½¿ç”¨Spring Securityæä¾›çš„ `DelegatingSecurityContextRunnable`

   ```java
   @Override
   public void afterCommit() {
       // è·å–å½“å‰å®‰å…¨ä¸Šä¸‹æ–‡
       SecurityContext context = SecurityContextHolder.getContext();
   
       CompletableFuture.runAsync(() -> {
           try {
               // åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡
               SecurityContextHolder.setContext(context);
               // ... å…¶ä»–ä»£ç  ...
               meetingMailProducer.sendMeetingApplyMail();
           } finally {
               // æ¸…ç†å®‰å…¨ä¸Šä¸‹æ–‡
               SecurityContextHolder.clearContext();
           }
       }, executor);
   }
   ```

   æˆ–è€…

   ```java
   registerSynchronization(new TransactionSynchronization() {
       @Override
       public void afterCommit() {
           Runnable originalTask = () -> {
               meetingMailProducer.sendMeetingApplyMail();
           };
          
           // åŒ…è£…ä»»åŠ¡ä»¥ä¼ é€’å®‰å…¨ä¸Šä¸‹æ–‡
           Runnable contextTask = new DelegatingSecurityContextRunnable(originalTask);
           CompletableFuture.runAsync(contextTask, executor);
       }
   });
   
   ```

   
